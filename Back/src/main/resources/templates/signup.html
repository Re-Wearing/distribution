<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <title>회원가입 | RE-WEAR</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSRF (Spring Security + Thymeleaf) -->
    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

    <style>
        :root{--bd:#e5e7eb;--txt:#111827;--sub:#6b7280;--ok:#065f46;--warn:#b91c1c;--bg:#f7f7fb}
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
        .wrap{max-width:560px;margin:40px auto;padding:0 16px}
        .card{background:#fff;border:1px solid var(--bd);border-radius:14px;padding:20px}
        h1{font-size:20px;margin:0 0 14px}
        .row{margin:10px 0}
        label{display:block;font-weight:600;margin-bottom:6px}
        input[type="text"],input[type="password"],input[type="email"]{
            width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:14px;background:#fff
        }
        .field-line{display:flex;gap:8px;align-items:center}
        .btn{padding:10px 12px;border:1px solid var(--bd);border-radius:10px;background:#fff;cursor:pointer;font-size:14px}
        .btn[disabled]{opacity:.6;cursor:not-allowed}
        small.help{display:block;margin-top:6px;font-size:12px;color:var(--sub);min-height:16px}
        small.ok{color:var(--ok)}
        small.warn{color:var(--warn)}
        .msg-top{margin-bottom:10px;padding:10px 12px;border-radius:10px;border:1px solid #a7f3d0;background:#ecfdf5;color:#065f46}
        .msg-top.warn{border-color:#fed7aa;background:#fff7ed;color:#b45309}
        .flex{display:flex;gap:8px}
        .hidden{display:none}
        .muted{color:#6b7280}
        .grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .actions{margin-top:14px;display:flex;gap:8px}
        .divider{height:1px;background:#f1f5f9;margin:14px 0}
        .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:20px}
        .modal{background:#fff;border:1px solid var(--bd);border-radius:16px;max-width:420px;width:100%;padding:18px}
        .modal h3{margin:0 0 12px;font-size:18px}
        .type-btn{display:block;width:100%;text-align:center;padding:12px;border:1px solid var(--bd);border-radius:12px;background:#fff;cursor:pointer}
    </style>
</head>
<body>
<div class="wrap">
    <div th:replace="~{fragments/nav :: mainNav}"></div>

    <div class="card">
        <h1>회원가입</h1>

        <!-- 유형 선택: hidden 필드 (ENUM: USER / ORGAN) -->
        <!-- 상단 글로벌 메시지 -->
        <div th:if="${errorMessage != null}" class="msg-top warn" th:text="${errorMessage}"></div>

        <form th:action="@{/signup}" th:object="${form}" method="post" id="signupForm" novalidate>
            <!-- 글로벌 에러 메시지 -->
            <div th:if="${#fields.hasGlobalErrors()}" class="msg-top warn">
                <div th:each="e : ${#fields.globalErrors()}" th:text="${e}"></div>
            </div>
            <!-- 서버 ENUM과 매핑 -->
            <input type="hidden" th:field="*{registrationType}" id="registrationType">
            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

            <!-- 유형 배지 + 변경 버튼 (초기 텍스트 SSR 반영) -->
            <div class="row" id="typeBadgeRow">
                <span class="muted">가입 유형:</span>
                <strong id="typeBadge" th:text="*{organ} ? '기관 회원' : '일반 회원'">일반 회원</strong>
                <button type="button" class="btn" id="btnChangeType">유형 변경</button>
            </div>

            <!-- 아이디 -->
            <div class="row">
                <label>아이디</label>
                <input type="text" th:field="*{username}" required minlength="5" maxlength="12"
                       pattern="[A-Za-z0-9._-]+" placeholder="영문/숫자/._- 5~12자">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('username')}" th:errors="*{username}"></small>
            </div>

            <!-- 비밀번호 -->
            <div class="row">
                <label>비밀번호</label>
                <input type="password" th:field="*{password}" required minlength="5" placeholder="5자 이상">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('password')}" th:errors="*{password}"></small>
            </div>

            <!-- 이름 -->
            <div class="row">
                <label>이름</label>
                <input type="text" th:field="*{name}" required maxlength="30">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('name')}" th:errors="*{name}"></small>
            </div>

            <!-- 이메일 + 인증 -->
            <div class="row">
                <label>이메일</label>
                <div class="field-line">
                    <input type="email" id="email" th:field="*{email}" required style="flex:1">
                    <button type="button" class="btn" id="btnSend">인증코드 전송</button>
                </div>
                <small id="sendMsg" class="help"></small>
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('email')}" th:errors="*{email}"></small>
            </div>

            <div class="row">
                <label>인증코드</label>
                <div class="field-line">
                    <input type="text" id="code" maxlength="6" placeholder="6자리" style="flex:1">
                    <button type="button" class="btn" id="btnVerify" disabled>인증 확인</button>
                </div>
                <small id="verifyMsg" class="help"></small>
            </div>

            <!-- 전화번호 -->
            <div class="row">
                <label>전화번호</label>
                <input type="text" th:field="*{phone}" inputmode="numeric"
                       pattern="^01[0-9]{8,9}$" placeholder="숫자만 10~11자리 (예: 01012345678)">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('phone')}" th:errors="*{phone}"></small>
            </div>

            <!-- 우편번호 -->
            <div class="row">
                <label>우편번호</label>
                <input type="text" th:field="*{addressPostcode}" maxlength="5" inputmode="numeric"
                       pattern="[0-9]{5}" placeholder="우편번호 5자리 (예: 12345)">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('addressPostcode')}" th:errors="*{addressPostcode}"></small>
            </div>

            <!-- 주소 -->
            <div class="row">
                <label>주소</label>
                <textarea th:field="*{address}" maxlength="255" placeholder="주소를 입력하세요 (최대 255자)" style="width:100%;padding:10px 12px;border:1px solid var(--bd);border-radius:10px;font-size:14px;background:#fff;min-height: 80px;"></textarea>
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('address')}" th:errors="*{address}"></small>
            </div>

            <!-- 닉네임 (기관 가입 시: 기관명과 동일, 읽기 전용 처리) -->
            <div class="row">
                <label>닉네임 <span class="muted" id="nickHint" th:text="*{organ} ? '(기관명과 동일하게 설정됩니다)' : '(선택 사항)'">(선택 사항)</span></label>
                <input type="text" th:field="*{nickname}" maxlength="50" id="nickname" th:readonly="*{organ}">
                <small class="help warn" th:if="${#fields != null && #fields.hasErrors('nickname')}" th:errors="*{nickname}"></small>
            </div>

            <!-- 기관 가입 전용 섹션 (SSR로도 초기 제어) -->
            <div id="organSection" class="row" th:classappend="*{organ} ? '' : ' hidden'">
                <div class="divider"></div>
                <div class="row">
                    <label>기관명</label>
                    <input type="text" th:field="*{orgName}" id="orgName" maxlength="100" placeholder="기관명을 입력하세요">
                    <small class="help warn" th:if="${#fields != null && #fields.hasErrors('orgName')}" th:errors="*{orgName}"></small>
                </div>
                <div class="row">
                    <label>사업자 번호</label>
                    <input type="text" th:field="*{businessNo}" id="businessNo" maxlength="10"
                           pattern="^[0-9]{10}$" placeholder="숫자 10자리 (예: 1234567890)">
                    <small class="help warn" th:if="${#fields != null && #fields.hasErrors('businessNo')}" th:errors="*{businessNo}"></small>
                </div>
            </div>

            <div class="actions">
                <button id="btnSubmit" class="btn" type="submit" disabled>회원가입</button>
                <a class="btn" th:href="@{/login}">취소</a>
            </div>
        </form>
    </div>
</div>

<!-- 유형 선택 모달 -->
<div class="modal-back" id="typeModal">
    <div class="modal">
        <h3>가입 유형을 선택하세요</h3>
        <div class="grid2">
            <button type="button" class="type-btn" data-type="USER">일반 회원으로 가입하기</button>
            <button type="button" class="type-btn" data-type="ORGAN">기관으로 가입하기</button>
        </div>
    </div>
</div>

<script>
    (function(){
        const $  = s => document.querySelector(s);
        const $$ = s => document.querySelectorAll(s);

        // CSRF (meta에서 읽어 fetch 헤더에 추가)
        const CSRF_TOKEN  = document.querySelector('meta[name="_csrf"]')?.content || "";
        const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content || "X-CSRF-TOKEN";

        const registrationType = $("#registrationType");
        const typeBadge = $("#typeBadge");
        const typeModal = $("#typeModal");
        const btnChangeType = $("#btnChangeType");

        const organSection = $("#organSection");
        const orgName = $("#orgName");
        const businessNo = $("#businessNo");
        const nickname = $("#nickname");
        const nickHint = $("#nickHint");

        const btnSend = $("#btnSend");
        const btnVerify = $("#btnVerify");
        const btnSubmit = $("#btnSubmit");
        const email = $("#email");
        const code = $("#code");
        const sendMsg = $("#sendMsg");
        const verifyMsg = $("#verifyMsg");

        let timer=null, remain=0, emailLocked=null, verified=false;

        function openTypeModal(){ typeModal.style.display='flex'; }
        function closeTypeModal(){ typeModal.style.display='none'; }

        function setType(t /* 'USER' | 'ORGAN' */){
            const v = (t || 'USER').toUpperCase();
            registrationType.value = v;
            typeBadge.textContent = (v === 'ORGAN') ? '기관 회원' : '일반 회원';

            const organ = (v === 'ORGAN');
            organSection.classList.toggle('hidden', !organ);
            nickname.readOnly = organ;
            nickHint.textContent = organ ? '(기관명과 동일하게 설정됩니다)' : '(선택 사항)';

            if (organ && orgName && orgName.value){
                nickname.value = orgName.value;
            }
        }

        // 초기: URL ?type=user|organ → ENUM 대문자로 정규화, 없으면 서버 값 사용
        (function initType(){
            const urlType = new URLSearchParams(location.search).get('type');
            const fromUrl = urlType ? urlType.toString().trim().toUpperCase() : null;
            const current = registrationType.value && registrationType.value.trim();
            if (fromUrl === 'USER' || fromUrl === 'ORGAN') {
                setType(fromUrl);
            } else if (current === 'USER' || current === 'ORGAN') {
                setType(current);
            } else {
                setType('USER');
                openTypeModal();
            }
        })();

        btnChangeType.addEventListener('click', openTypeModal);
        $$(".type-btn").forEach(b=>{
            b.addEventListener('click', ()=>{
                setType(b.dataset.type);
                closeTypeModal();
            });
        });

        // 기관명 변경 시 닉네임 자동 반영(기관모드일 때만)
        orgName && orgName.addEventListener('input', ()=>{
            if (registrationType.value === 'ORGAN'){
                nickname.value = orgName.value || '';
            }
        });

        // --- 이메일 인증 ---
        function startTimer(sec){
            remain = sec; updateSendMsg();
            timer = setInterval(()=>{
                remain--; updateSendMsg();
                if(remain<=0){
                    clearInterval(timer); timer=null;
                    btnVerify.disabled=true; verifyMsg.textContent='';
                }
            }, 1000);
        }
        function updateSendMsg(){
            sendMsg.textContent = remain>0 ? `인증코드 유효시간 ${remain}s` : '';
        }

        btnSend.addEventListener("click", async ()=>{
            if(!email.value){ alert("이메일을 입력하세요."); return; }
            const res = await fetch("/api/auth/send-verification", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    [CSRF_HEADER]: CSRF_TOKEN
                },
                body: JSON.stringify({ email: email.value })
            });
            const data = await res.json().catch(()=>({ok:false}));
            if(res.ok && data.ok){
                alert("인증코드를 전송했습니다. 메일함을 확인하세요.");
                btnVerify.disabled = false;
                emailLocked = email.value;
                verified = false;
                btnSubmit.disabled = true;
                verifyMsg.textContent = "";
                if(timer) clearInterval(timer);
                startTimer(180);
            }else{
                alert(data.message || "인증코드 전송에 실패했습니다.");
            }
        });

        email.addEventListener("input", ()=>{
            if(emailLocked && email.value !== emailLocked){
                btnVerify.disabled = true; verified = false; btnSubmit.disabled = true; verifyMsg.textContent = "";
            }
        });

        btnVerify.addEventListener("click", async ()=>{
            if(!code.value || code.value.length !== 6){ alert("6자리 인증코드를 입력하세요."); return; }
            if(!emailLocked || email.value !== emailLocked){ alert("코드를 전송한 이메일과 달라요."); return; }
            const res = await fetch("/api/auth/verify-code", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "Content-Type": "application/json",
                    [CSRF_HEADER]: CSRF_TOKEN
                },
                body: JSON.stringify({ email: email.value, code: code.value })
            });
            const data = await res.json().catch(()=>({ok:false}));
            if(res.ok && data.ok){
                verified = true;
                verifyMsg.textContent = "이메일 인증이 완료되었습니다."; verifyMsg.className = "help ok";
                btnSubmit.disabled = false;
                if(timer){ clearInterval(timer); timer=null; updateSendMsg(); }
            }else{
                verified = false;
                verifyMsg.textContent = data.message || "이메일 인증코드가 올바르지 않습니다."; verifyMsg.className = "help warn";
                btnSubmit.disabled = true;
            }
        });

        // 서버 측에서도 최종 검증하지만, UX상 기관모드에서 필수값 체크
        $("#signupForm").addEventListener("submit", (e)=>{
            if(registrationType.value === 'ORGAN'){
                if(!orgName.value){ alert("기관명을 입력하세요."); e.preventDefault(); return; }
                if(!businessNo.value){ alert("사업자 번호를 입력하세요."); e.preventDefault(); return; }
                nickname.value = orgName.value; // 동기화 안전장치
            }
            if(!verified){
                alert("이메일 인증을 완료해 주세요.");
                e.preventDefault();
            }
        });
    })();
</script>
</body>
</html>
